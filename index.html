<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Asteroides e Cometas Próximos da Terra!</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f9f9f9;
    }

    h1 {
      margin-bottom: 10px;
    }

    input, button {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
    }

    #status {
      margin-top: 10px;
      font-size: 18px;
      color: #333;
    }

    #erro {
      color: red;
      font-weight: bold;
      margin-top: 10px;
    }

    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }

    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }

    th {
      background-color: #eee;
    }

    tr.perigoso {
      background-color: #ffe5e5;
      font-weight: bold;
    }

    tr:hover {
      background-color: #f1f1f1;
      cursor: pointer;
    }

    #orbita {
      width: 100%;
      max-width: 800px;
      height: 500px;
      margin: 30px auto;
      border: 1px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
<body>
  <h1>🌍 Asteroides e Cometas Próximos da Terra</h1>

  <label for="date">Escolhe uma data:</label>
  <input type="date" id="date" value="2025-09-07" />
  <button onclick="buscarObjetos()">🔍 Ver Objetos</button>

  <div id="status"></div>
  <div id="erro"></div>

  <table id="neo-table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Magnitude</th>
        <th>Diâmetro Mín (km)</th>
        <th>Diâmetro Máx (km)</th>
        <th>Perigoso?</th>
        <th>Data Aproximação</th>
        <th>Velocidade (km/h)</th>
        <th>Distância (km)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="orbita"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let cena, camera, renderer, controls;
    let objetosAnimados = [];
    let label;
    let objetoSelecionado = null;
    let terra, lua, sol;

    function inicializarOrbita() {
      cena = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, 800 / 500, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(800, 500);
      document.getElementById('orbita').appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);
      controls.enableZoom = true;
      controls.enablePan = true;
      controls.enableRotate = true;

      sol = new THREE.Mesh(
        new THREE.SphereGeometry(1, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0xffff00 })
      );
      cena.add(sol);

      const terraRaioOrbita = 15;
      terra = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0x3366ff })
      );
      cena.add(terra);

      const orbitaTerra = new THREE.Mesh(
        new THREE.TorusGeometry(terraRaioOrbita, 0.02, 16, 100),
        new THREE.MeshBasicMaterial({ color: 0x9999ff })
      );
      orbitaTerra.rotation.x = Math.PI / 2;
      cena.add(orbitaTerra);

      const luaRaioOrbita = 1.5;
      lua = new THREE.Mesh(
        new THREE.SphereGeometry(0.2, 16, 16),
        new THREE.MeshBasicMaterial({ color: 0xcccccc })
      );
      cena.add(lua);

      terra.objData = { raio: terraRaioOrbita, angulo: 0, velocidade: 0.001 };
      lua.objData = { raio: luaRaioOrbita, angulo: 0, velocidade: 0.01 };

      camera.position.z = 50;
      animate();
    }

    function animate() {
      requestAnimationFrame(animate);
      controls.update();

      terra.objData.angulo += terra.objData.velocidade;
      terra.position.x = terra.objData.raio * Math.cos(terra.objData.angulo);
      terra.position.z = terra.objData.raio * Math.sin(terra.objData.angulo);

      lua.objData.angulo += lua.objData.velocidade;
      lua.position.x = terra.position.x + lua.objData.raio * Math.cos(lua.objData.angulo);
      lua.position.z = terra.position.z + lua.objData.raio * Math.sin(lua.objData.angulo);

      objetosAnimados.forEach(obj => {
        obj.angulo += obj.velocidade;
        obj.mesh.position.x = obj.raio * Math.cos(obj.angulo);
        obj.mesh.position.z = obj.raio * Math.sin(obj.angulo);
      });

      renderer.render(cena, camera);
    }

    function mostrarLabel(texto, posicao) {
      if (label) cena.remove(label);

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.font = '20px Arial';
      canvas.width = ctx.measureText(texto).width + 20;
      canvas.height = 30;
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black';
      ctx.fillText(texto, 10, 20);

      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.SpriteMaterial({ map: texture });
      label = new THREE.Sprite(material);
      label.position.copy(posicao.clone().add(new THREE.Vector3(0, 0.5, 0)));
      label.scale.set(2, 1, 1);
      cena.add(label);
    }

    function focarObjeto(posicao) {
      const destino = posicao.clone().add(new THREE.Vector3(0, 0, 10));
      const duracao = 30;
      let frame = 0;
      const origem = camera.position.clone();

      function mover() {
        frame++;
        const t = frame / duracao;
        camera.position.lerpVectors(origem, destino, t);
        controls.target.lerpVectors(controls.target, posicao, t);
        controls.update();
        if (frame < duracao) requestAnimationFrame(mover);
      }

      mover();
    }

    function desenharCometa(distanciaAU, velocidade, nome) {
      const direcao = new THREE.Vector3(1, 0, 0).normalize();
      const origem = new THREE.Vector3(-distanciaAU * 10, 0, 0);
      const destino = new THREE.Vector3(distanciaAU * 10, 0, 0);

      const cometa = new THREE.Mesh(
        new THREE.SphereGeometry(0.15, 16, 16),
        new THREE.MeshBasicMaterial({ color: 0x00ffff })
      );
      cometa.position.copy(origem);
      cena.add(cometa);

      const cauda = new THREE.Mesh(
        new THREE.CylinderGeometry(0.02, 0.1, 1, 8),
        new THREE.MeshBasicMaterial({ color: 0x99ccff })
      );
      cauda.position.copy(origem.clone().add(direcao.clone().multiplyScalar(-0.5)));
      cauda.rotation.z = Math.PI / 2;
      cena.add(cauda);

      objetosAnimados.push({
        mesh: cometa,
        raio: 0,
        angulo: 0,
        velocidade: velocidade / 1000000,
        nome: nome,
        originalColor: 0x00ffff,
        tipo: 'Cometa'
      });
    }

    function desenharAsteroide(distanciaAU, cor = 0x00ff00, separador = 0, nome = '') {
      const raio = Math.max(distanciaAU * 10 + separador, 5);

      const orbita = new THREE.Mesh(
        new THREE.TorusGeometry(raio, 0.02, 16, 100),
        new THREE.MeshBasicMaterial({ color: cor })
      );
      orbita.rotation.x = Math.PI / 2;
      cena.add(orbita);

      const asteroide = new THREE.Mesh(
        new THREE.SphereGeometry(0.1, 16, 16),
        new THREE.MeshBasicMaterial({ color: cor })
      );
      cena.add(asteroide);

      objetosAnimados.push({
        mesh: asteroide,
        raio: raio,
        angulo: Math.random() * Math.PI * 2,
        velocidade: 0.002 + Math.random() * 0.003,
        nome: nome,
        originalColor: cor,
        tipo: 'Asteroide'
      });
    }

    function limparOrbita() {
      cena.children = cena.children.filter(obj =>
        obj === sol || obj === terra || obj === lua || obj.type === 'PerspectiveCamera'
      );
      objetosAnimados = [];
      label = null;
      objetoSelecionado = null;
    }

    function buscarObjetos() {
      const dataSelecionada = document.getElementById('date').value;
      const url = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${dataSelecionada}&end_date=${dataSelecionada}&api_key=QGdjDosaNi342L5tT7qpE1QdWeMcbdb5LeHdHXSk`;
      const urlCometas = `https://ssd-api.jpl.nasa.gov/cad.api?date=${dataSelecionada}&body=Earth&kind=C`;

      document.getElementById('status').textContent = 'A carregar dados...';
      document.getElementById('erro').textContent = '';

      Promise.all([
        fetch(urlAsteroides).then(r => r.json()),
        fetch(urlCometas).then(r => r.json())
      ])
      .then(([dadosAsteroides, dadosCometas]) => {
        const neos = dadosAsteroides?.near_earth_objects?.[dataSelecionada] || [];
        const cometas = dadosCometas?.data || [];

        const tbody = document.querySelector('#neo-table tbody');
        tbody.innerHTML = '';
        limparOrbita();

        let desenhados = 0;
        let maiorDistanciaAU = 0;

        neos.forEach((neo, index) => {
          const approach = neo.close_approach_data[0];
          const perigoso = neo.is_potentially_hazardous_asteroid;

          let distanciaAU = parseFloat(approach?.miss_distance?.au);
          if (isNaN(distanciaAU)) {
            const distanciaKm = parseFloat(approach?.miss_distance?.kilometers);
            if (!isNaN(distanciaKm)) {
              distanciaAU = distanciaKm / 149597870.7;
            }
          }

          if (!isNaN(distanciaAU)) {
            desenharAsteroide(distanciaAU, perigoso ? 0xff0000 : 0x00ff00, index * 2, neo.name);
            desenhados++;
            if (distanciaAU > maiorDistanciaAU) maiorDistanciaAU = distanciaAU;
          }

          const row = document.createElement('tr');
          if (perigoso) row.classList.add('perigoso');

          row.innerHTML = `
            <td>${neo.name}</td>
            <td>Asteroide</td>
            <td>${neo.absolute_magnitude_h}</td>
            <td>${neo.estimated_diameter.kilometers.estimated_diameter_min.toFixed(3)}</td>
            <td>${neo.estimated_diameter.kilometers.estimated_diameter_max.toFixed(3)}</td>
            <td>${perigoso ? '⚠️ Sim' : 'Não'}</td>
            <td>${approach.close_approach_date}</td>
            <td>${parseFloat(approach.relative_velocity.kilometers_per_hour).toFixed(2)}</td>
            <td>${parseFloat(approach.miss_distance.kilometers).toFixed(0)}</td>
          `;
          tbody.appendChild(row);

          row.addEventListener('click', () => {
            const objeto = objetosAnimados[index];
            if (objeto) {
              if (objetoSelecionado) {
                objetoSelecionado.mesh.material.color.setHex(objetoSelecionado.originalColor);
              }

              objeto.mesh.material.color.setHex(0x3399ff);
              objetoSelecionado = objeto;

              const posicao = objeto.mesh.position.clone();
              mostrarLabel(objeto.nome, posicao);
              focarObjeto(posicao);
            }
          });
        });

        cometas.forEach((c, i) => {
          const nome = c[0];
          const distanciaAU = parseFloat(c[4]);
          const velocidade = parseFloat(c[7]);

          if (!isNaN(distanciaAU) && !isNaN(velocidade)) {
            desenharCometa(distanciaAU, velocidade, nome);
            desenhados++;
          }

          const row = document.createElement('tr');
          row.innerHTML = `
            <td>${nome}</td>
            <td>Cometa</td>
            <td>–</td>
            <td>–</td>
            <td>–</td>
            <td>Não</td>
            <td>${c[3]}</td>
            <td>${parseFloat(c[7]).toFixed(2)}</td>
            <td>${parseFloat(c[4] * 149597870.7).toFixed(0)}</td>
          `;
          tbody.appendChild(row);

          row.addEventListener('click', () => {
            const objeto = objetosAnimados[neos.length + i];
            if (objeto) {
              if (objetoSelecionado) {
                objetoSelecionado.mesh.material.color.setHex(objetoSelecionado.originalColor);
              }

              objeto.mesh.material.color.setHex(0x3399ff);
              objetoSelecionado = objeto;

              const posicao = objeto.mesh.position.clone();
              mostrarLabel(objeto.nome, posicao);
              focarObjeto(posicao);
            }
          });
        });

        document.getElementById('status').textContent = `Foram encontrados ${desenhados} objetos próximos da Terra.`;
        if (desenhados === 0) {
          document.getElementById('erro').textContent = '⚠️ Nenhum objeto foi desenhado no mapa.';
        }
      })
      .catch(error => {
        document.getElementById('status').textContent = '';
        document.getElementById('erro').textContent = 'Erro ao obter dados. Verifica a data ou tenta mais tarde.';
      });
    }

    inicializarOrbita();
    buscarObjetos();
  </script>
</body>
</html>