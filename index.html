<!DOCTYPE html>
<html lang="pt">
<head>
  <meta charset="UTF-8">
  <title>Asteroides e Cometas Pr√≥ximos da Terra</title>
  <style>
    body {
      font-family: Arial, sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #f9f9f9;
    }
    h1 { margin-bottom: 10px; }
    input, button {
      padding: 8px;
      margin: 10px;
      font-size: 16px;
    }
    #status { margin-top: 10px; font-size: 18px; color: #333; }
    #erro {
      color: red;
      font-weight: bold;
      margin-top: 10px;
      white-space: pre-line;
    }
    table {
      width: 95%;
      margin: 20px auto;
      border-collapse: collapse;
      box-shadow: 0 0 10px rgba(0,0,0,0.1);
    }
    th, td {
      border: 1px solid #ccc;
      padding: 8px;
      text-align: center;
    }
    th { background-color: #eee; }
    tr.perigoso { background-color: #ffe5e5; font-weight: bold; }
    tr:hover { background-color: #f1f1f1; cursor: pointer; }
    #orbita {
      width: 100%;
      max-width: 800px;
      height: 500px;
      margin: 30px auto;
      border: 1px solid #ccc;
      display: flex;
      justify-content: center;
      align-items: center;
    }
  </style>
</head>
// BLOCO 2
<body>
  <h1>üåç Asteroides e Cometas Pr√≥ximos da Terra</h1>
  <label for="date">Escolhe uma data:</label>
  <input type="date" id="date" value="2025-09-07" />
  <button onclick="buscarObjetos()">üîç Ver Objetos</button>
  <div id="status"></div>
  <div id="erro"></div>

  <table id="neo-table">
    <thead>
      <tr>
        <th>Nome</th>
        <th>Tipo</th>
        <th>Magnitude</th>
        <th>Di√¢metro M√≠n (km)</th>
        <th>Di√¢metro M√°x (km)</th>
        <th>Perigoso?</th>
        <th>Data Aproxima√ß√£o</th>
        <th>Velocidade (km/h)</th>
        <th>Dist√¢ncia (km)</th>
      </tr>
    </thead>
    <tbody></tbody>
  </table>

  <div id="orbita"></div>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/r134/three.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/three@0.134.0/examples/js/controls/OrbitControls.js"></script>

  <script>
    let cena, camera, renderer, controls;
    let objetosAnimados = [];
    let label;
    let objetoSelecionado = null;
    let terra, lua, sol, marte;

    function inicializarOrbita() {
      cena = new THREE.Scene();
      camera = new THREE.PerspectiveCamera(75, 800 / 500, 0.1, 1000);
      renderer = new THREE.WebGLRenderer();
      renderer.setSize(800, 500);
      document.getElementById('orbita').appendChild(renderer.domElement);

      controls = new THREE.OrbitControls(camera, renderer.domElement);

      sol = new THREE.Mesh(
        new THREE.SphereGeometry(1, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0xffff00 })
      );
      cena.add(sol);

      const escala = 10;
      const terraRaioOrbita = 1.0 * escala; // Terra: 1 AU
      terra = new THREE.Mesh(
        new THREE.SphereGeometry(0.5, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0x3366ff })
      );
      cena.add(terra);

      const orbitaTerra = new THREE.Mesh(
        new THREE.TorusGeometry(terraRaioOrbita, 0.02, 16, 100),
        new THREE.MeshBasicMaterial({ color: 0x9999ff })
      );
      orbitaTerra.rotation.x = Math.PI / 2;
      cena.add(orbitaTerra);

      const luaRaioOrbita = 1.5;
      lua = new THREE.Mesh(
        new THREE.SphereGeometry(0.2, 16, 16),
        new THREE.MeshBasicMaterial({ color: 0xcccccc })
      );
      cena.add(lua);

      const marteRaioOrbita = 1.524 * escala; // Marte: 1.524 AU
      marte = new THREE.Mesh(
        new THREE.SphereGeometry(0.4, 32, 32),
        new THREE.MeshBasicMaterial({ color: 0xff6633 })
      );
      cena.add(marte);

      const orbitaMarte = new THREE.Mesh(
        new THREE.TorusGeometry(marteRaioOrbita, 0.02, 16, 100),
        new THREE.MeshBasicMaterial({ color: 0xff9966 })
      );
      orbitaMarte.rotation.x = Math.PI / 2;
      cena.add(orbitaMarte);

      terra.objData = { raio: terraRaioOrbita, angulo: 0, velocidade: 0.001 };
      lua.objData = { raio: luaRaioOrbita, angulo: 0, velocidade: 0.01 };
      marte.objData = { raio: marteRaioOrbita, angulo: 0, velocidade: 0.0005 };

      camera.position.z = 50;
      animate();
    }
// BLOCO 3
function animate() {
      requestAnimationFrame(animate);
      controls.update();

      // Terra
      terra.objData.angulo += terra.objData.velocidade;
      terra.position.x = terra.objData.raio * Math.cos(terra.objData.angulo);
      terra.position.z = terra.objData.raio * Math.sin(terra.objData.angulo);

      // Lua
      lua.objData.angulo += lua.objData.velocidade;
      lua.position.x = terra.position.x + lua.objData.raio * Math.cos(lua.objData.angulo);
      lua.position.z = terra.position.z + lua.objData.raio * Math.sin(lua.objData.angulo);

      // Marte
      marte.objData.angulo += marte.objData.velocidade;
      marte.position.x = marte.objData.raio * Math.cos(marte.objData.angulo);
      marte.position.z = marte.objData.raio * Math.sin(marte.objData.angulo);

      // Objetos animados (asteroides e cometas)
      objetosAnimados.forEach(obj => {
  obj.angulo += obj.velocidade;
  obj.mesh.position.set(
    obj.raio * Math.cos(obj.angulo),
    0,
    obj.raio * Math.sin(obj.angulo)
  );

  // Atualiza trilho
  obj.trilho.push(obj.mesh.getWorldPosition(new THREE.Vector3()));
  if (obj.trilho.length > 100) obj.trilho.shift();

  const trilhoGeometry = new THREE.BufferGeometry().setFromPoints(obj.trilho);
  obj.linhaTrilho.geometry.dispose();
  obj.linhaTrilho.geometry = trilhoGeometry;
});

      renderer.render(cena, camera);
    }

    function mostrarLabel(texto, posicao) {
      if (label) cena.remove(label);

      const canvas = document.createElement('canvas');
      const ctx = canvas.getContext('2d');
      ctx.font = '20px Arial';
      canvas.width = ctx.measureText(texto).width + 20;
      canvas.height = 30;
      ctx.fillStyle = 'white';
      ctx.fillRect(0, 0, canvas.width, canvas.height);
      ctx.fillStyle = 'black';
      ctx.fillText(texto, 10, 20);

      const texture = new THREE.CanvasTexture(canvas);
      const material = new THREE.SpriteMaterial({ map: texture });
      label = new THREE.Sprite(material);
      label.position.copy(posicao.clone().add(new THREE.Vector3(0, 0.5, 0)));
      label.scale.set(2, 1, 1);
      cena.add(label);
    }

    function focarObjeto(posicao) {
      const destino = posicao.clone().add(new THREE.Vector3(0, 0, 10));
      const duracao = 30;
      let frame = 0;
      const origem = camera.position.clone();

      function mover() {
        frame++;
        const t = frame / duracao;
        camera.position.lerpVectors(origem, destino, t);
        controls.target.lerpVectors(controls.target, posicao, t);
        controls.update();
        if (frame < duracao) requestAnimationFrame(mover);
      }

      mover();
    }

function desenharOrbitaReal(a, e, i, omega, Omega, nome = '', cor = 0xffffff) {
  const escala = 10;
  const grupo = new THREE.Group();
  cena.add(grupo);

  const mesh = new THREE.Mesh(
    new THREE.SphereGeometry(0.1, 16, 16),
    new THREE.MeshBasicMaterial({ color: cor })
  );
  grupo.add(mesh);

  grupo.rotation.z = THREE.MathUtils.degToRad(Omega);
  grupo.rotation.x = THREE.MathUtils.degToRad(i);
  grupo.rotation.y = THREE.MathUtils.degToRad(omega);

  const periodo = Math.sqrt(a * a * a);
  const velocidadeAngular = 2 * Math.PI / (periodo * 365);
  const velocidadePorFrame = velocidadeAngular / 60;

  const objeto = {
    mesh: mesh,
    grupo: grupo,
    raio: a * escala,
    angulo: Math.random() * Math.PI * 2,
    velocidade: velocidadePorFrame,
    nome: nome,
    originalColor: cor,
    tipo: 'Orbital',
    trilho: [],
    linhaTrilho: new THREE.Line(
      new THREE.BufferGeometry(),
      new THREE.LineBasicMaterial({ color: cor, transparent: true, opacity: 0.6 })
    )
  };

  cena.add(objeto.linhaTrilho);
  objetosAnimados.push(objeto);
  return objeto;
}

    function limparOrbita() {
      cena.children = cena.children.filter(obj =>
        obj === sol || obj === terra || obj === lua || obj === marte || obj.type === 'PerspectiveCamera'
      );
      objetosAnimados = [];
      label = null;
      objetoSelecionado = null;
    }
// BLOCO 4
function proximaData(data) {
      const d = new Date(data);
      d.setDate(d.getDate() + 7);
      return d.toISOString().split('T')[0];
    }

    function buscarObjetos() {
      const dataSelecionada = document.getElementById('date').value;

      const urlAsteroides = `https://api.nasa.gov/neo/rest/v1/feed?start_date=${dataSelecionada}&end_date=${dataSelecionada}&api_key=QGdjDosaNi342L5tT7qpE1QdWeMcbdb5LeHdHXSk`;
      const urlCometas = `https://ssd-api.jpl.nasa.gov/cad.api?date-min=${dataSelecionada}&date-max=${proximaData(dataSelecionada)}&body=Earth&kind=C`;

      document.getElementById('status').textContent = 'A carregar dados...';
      document.getElementById('erro').textContent = '';
      const tbody = document.querySelector('#neo-table tbody');
      tbody.innerHTML = '';
      limparOrbita();

      let desenhados = 0;

      // ASTEROIDES
      fetch(urlAsteroides)
        .then(r => r.json())
        .then(dadosAsteroides => {
          const neos = dadosAsteroides?.near_earth_objects?.[dataSelecionada] || [];

          if (neos.length === 0) {
            document.getElementById('erro').textContent = '‚ÑπÔ∏è Nenhum asteroide registado para esta data.';
          }

          neos.forEach((neo) => {
            const approach = neo.close_approach_data[0];
            const perigoso = neo.is_potentially_hazardous_asteroid;
            const cor = perigoso ? 0xff0000 : 0x00ff00;

            fetch(`https://api.nasa.gov/neo/rest/v1/neo/${neo.id}?api_key=QGdjDosaNi342L5tT7qpE1QdWeMcbdb5LeHdHXSk`)
              .then(r => r.json())
              .then(detalhes => {
                const orbita = detalhes.orbital_data;
                const a = parseFloat(orbita.semi_major_axis);
                const e = parseFloat(orbita.eccentricity);
                const i = parseFloat(orbita.inclination);
                const omega = parseFloat(orbita.perihelion_argument);
                const Omega = parseFloat(orbita.ascending_node_longitude);

                let objetoAsteroide = null;
                if (!isNaN(a) && !isNaN(e)) {
                  objetoAsteroide = desenharOrbitaReal(a, e, i, omega, Omega, neo.name, cor);
                  desenhados++;
                }

                const row = document.createElement('tr');
                if (perigoso) row.classList.add('perigoso');

                row.innerHTML = `
                  <td>${neo.name}</td>
                  <td>Asteroide</td>
                  <td>${neo.absolute_magnitude_h}</td>
                  <td>${neo.estimated_diameter.kilometers.estimated_diameter_min.toFixed(3)}</td>
                  <td>${neo.estimated_diameter.kilometers.estimated_diameter_max.toFixed(3)}</td>
                  <td>${perigoso ? '‚ö†Ô∏è Sim' : 'N√£o'}</td>
                  <td>${approach.close_approach_date}</td>
                  <td>${parseFloat(approach.relative_velocity.kilometers_per_hour).toFixed(2)}</td>
                  <td>${parseFloat(approach.miss_distance.kilometers).toFixed(0)}</td>
                `;
                tbody.appendChild(row);

                if (objetoAsteroide) {
                  row.objeto3D = objetoAsteroide;
                  row.addEventListener('click', () => {
                    const objeto = row.objeto3D;
                    if (objeto) {
                      if (objetoSelecionado) {
                        objetoSelecionado.mesh.material.color.setHex(objetoSelecionado.originalColor);
                      }
                      objeto.mesh.material.color.setHex(0x3399ff);
                      objetoSelecionado = objeto;
                      mostrarLabel(objeto.nome, objeto.mesh.position.clone());
                      focarObjeto(objeto.mesh.position.clone());
                    }
                  });
                }
              })
              .catch(() => {
                console.warn(`Erro ao obter dados orbitais para ${neo.name}`);
              });
          });
        })
        .catch(() => {
          document.getElementById('erro').textContent = '‚ö†Ô∏è Erro ao obter dados de asteroides.';
        });
// BLOCO 5
// COMETAS
      fetch(urlCometas)
        .then(r => r.json())
        .then(dadosCometas => {
          const cometas = Array.isArray(dadosCometas?.data) ? dadosCometas.data : [];

          if (cometas.length === 0) {
            document.getElementById('erro').textContent += '\n‚ÑπÔ∏è Nenhum cometa registado neste intervalo.';
            return;
          }

          cometas.forEach((c) => {
            const nome = c[0];
            const distanciaAU = parseFloat(c[4]);
            const velocidade = parseFloat(c[7]);

            // Par√¢metros orbitais estimados para visualiza√ß√£o
            const a = distanciaAU;
            const e = 0.85;
            const i = 45;
            const omega = 120;
            const Omega = 250;

            let objetoCometa = null;
            if (!isNaN(a) && !isNaN(e)) {
              objetoCometa = desenharOrbitaReal(a, e, i, omega, Omega, nome, 0x00ffff);
              desenhados++;
            }

            const row = document.createElement('tr');
            row.innerHTML = `
              <td>${nome}</td>
              <td>Cometa</td>
              <td>‚Äì</td>
              <td>‚Äì</td>
              <td>‚Äì</td>
              <td>N√£o</td>
              <td>${c[3]}</td>
              <td>${velocidade.toFixed(2)}</td>
              <td>${(distanciaAU * 149597870.7).toFixed(0)}</td>
            `;
            document.querySelector('#neo-table tbody').appendChild(row);

            if (objetoCometa) {
              row.objeto3D = objetoCometa;
              row.addEventListener('click', () => {
                const objeto = row.objeto3D;
                if (objeto) {
                  if (objetoSelecionado) {
                    objetoSelecionado.mesh.material.color.setHex(objetoSelecionado.originalColor);
                  }
                  objeto.mesh.material.color.setHex(0x3399ff);
                  objetoSelecionado = objeto;
                  mostrarLabel(objeto.nome, objeto.mesh.position.clone());
                  focarObjeto(objeto.mesh.position.clone());
                }
              });
            }
          });

          document.getElementById('status').textContent = `Foram encontrados ${desenhados} objetos pr√≥ximos da Terra.`;
          if (desenhados === 0) {
            document.getElementById('erro').textContent += '\n‚ö†Ô∏è Nenhum objeto foi desenhado no mapa.';
          }
        })
        .catch(() => {
          document.getElementById('erro').textContent += '\n‚ö†Ô∏è Erro ao obter dados de cometas.';
        });
    }

    inicializarOrbita();
    buscarObjetos();
  </script>
</body>
</html>